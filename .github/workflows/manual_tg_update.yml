# ==================================================================================================
# File: .github/workflows/manual_tg_update.yml
#
# Workflow Name: Manual update channel
#
# Description:
#   This GitHub Actions workflow is triggered manually via `workflow_dispatch`. It detects 
#   the first modified Markdown (.md) file from the latest commit, checks the file size to 
#   ensure it doesn't exceed Telegram's 4096 character limit, and sends its content to a specified 
#   Telegram channel using the Telegram Bot API.
#
# Use Case:
#   This workflow is useful for manually triggering updates to a Telegram channel when a 
#   Markdown file (e.g., changelog, documentation) is updated in a commit.
#
# Trigger:
#   - Event: workflow_dispatch
#     - This allows manual triggering of the workflow via GitHub Actions UI.
#
# Required Secrets:
#   - TELEGRAM_BOT_TOKEN: Token from @BotFather to send messages via Telegram Bot API
#   - TELEGRAM_CHANNEL_ID: Telegram channel ID where the message will be sent
#
# Assumptions:
#   - At least one Markdown file (.md) is modified in the commit.
#   - The file content is under Telegram's 4096 character limit for a message.
#
# Limitations:
#   - Only the first `.md` file found in the commit will be processed.
#   - If the file size exceeds Telegram's limit, the workflow will fail.
#
# Author: Dmitry Troshenkov <troshenkov.d@gmail.com>
# Last updated: 2025-04-20
# ==================================================================================================


name: Manual update channel

on:
  workflow_dispatch:

jobs:
  post_to_telegram:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Get current date
      id: get_date
      run: echo "CURRENT_DATE=$(date +'%Y-%m-%d')" >> $GITHUB_ENV

    - name: Rename latest.md to a date-based filename
      run: |
        NEW_FILE="updates/${CURRENT_DATE}.md"
        mv updates/latest.md $NEW_FILE
        echo "Renamed latest.md to $NEW_FILE"

    - name: Commit and push renamed file
      run: |
        GITHUB_USER_NAME="GitHub Actions Bot"
        GITHUB_USER_EMAIL="actions@github.com"

        git config user.name "${GITHUB_USER_NAME}"
        git config user.email "${GITHUB_USER_EMAIL}"

        git fetch origin
        git checkout main
        git pull origin main --rebase

        git add updates/${CURRENT_DATE}.md
        git commit -m "Rename latest.md to ${CURRENT_DATE}.md"
        git push origin main

    - name: Read the Markdown message content
      id: read_message
      run: |
        echo "msg<<EOF" >> $GITHUB_OUTPUT
        cat $NEW_FILE >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Send message to Telegram
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        echo "Bot Token: ${TELEGRAM_BOT_TOKEN::10}..."
        echo "Channel ID: $TELEGRAM_CHAT_ID"
        curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
          -d chat_id="${TELEGRAM_CHAT_ID}" \
          -d parse_mode="MarkdownV2" \
          --data-urlencode text="${{ steps.read_message.outputs.msg }}"

